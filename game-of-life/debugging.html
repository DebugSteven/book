<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Debugging - Rust and WebAssembly</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "../";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="../background-and-concepts.html"><strong aria-hidden="true">2.</strong> Background And Concepts</a></li><li><a href="../game-of-life/introduction.html"><strong aria-hidden="true">3.</strong> Tutorial</a></li><li><ol class="section"><li><a href="../game-of-life/setup.html"><strong aria-hidden="true">3.1.</strong> Setup</a></li><li><a href="../game-of-life/hello-world.html"><strong aria-hidden="true">3.2.</strong> Hello, World!</a></li><li><a href="../game-of-life/rules.html"><strong aria-hidden="true">3.3.</strong> Rules</a></li><li><a href="../game-of-life/implementing.html"><strong aria-hidden="true">3.4.</strong> Implementing Life</a></li><li><a href="../game-of-life/debugging.html" class="active"><strong aria-hidden="true">3.5.</strong> Debugging</a></li><li><a href="../game-of-life/interactivity.html"><strong aria-hidden="true">3.6.</strong> Adding Interactivity</a></li><li><a href="../game-of-life/time-profiling.html"><strong aria-hidden="true">3.7.</strong> Time Profiling</a></li><li><a href="../game-of-life/code-size.html"><strong aria-hidden="true">3.8.</strong> Shrinking .wasm Size</a></li><li><a href="../game-of-life/production.html"><strong aria-hidden="true">3.9.</strong> Production and Deployment</a></li><li class="spacer"></li></ol></li><li><a href="../crates.html"><strong aria-hidden="true">5.</strong> Crates You Should Know</a></li><li><a href="../tools.html"><strong aria-hidden="true">6.</strong> Tools You Should Know</a></li><li><a href="../js-ffi.html"><strong aria-hidden="true">7.</strong> JavaScript Interoperation</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Rust and WebAssembly</h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#debugging" id="debugging"><h1>Debugging</h1></a>
<p>Before we write much more code, we will want to have some debugging tools in our
belt for when things go wrong.</p>
<a class="header" href="#building-with-debug-symbols" id="building-with-debug-symbols"><h2>Building with Debug Symbols</h2></a>
<blockquote>
<p>âš¡ When debugging, always make sure you are building with debug symbols!</p>
</blockquote>
<p>If you don't have debug symbols enabled, then the <code>&quot;name&quot;</code> section won't be
present in the compiled <code>.wasm</code> binary, and stack traces will have function
names like <code>wasm[42]</code> rather than
<code>wasm_game_of_life::Universe::live_neighbor_count</code>.</p>
<p>When using a &quot;debug&quot; build (aka <code>npm run build-debug</code>) debug symbols are enabled
by default.</p>
<p>With a &quot;release&quot; build, debug symbols are not enabled by default. To enable
debug symbols, ensure that you <code>debug = true</code> in the <code>[profile.release]</code> section
of your <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[profile.release]
debug = true
</code></pre>
<p>The project template we've been working with adds this to <code>Cargo.toml</code> by
default, for convenience.</p>
<a class="header" href="#logging" id="logging"><h2>Logging</h2></a>
<p>Logging is one of the most effective tools we have for proving and disproving
hypotheses about why our programs are buggy. On the Web, the <code>console.log</code>
function is the way to log messages to the browser's developer tools console. We
can use <code>wasm_bindgen</code> to import a reference to it, like this:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
#[wasm_bindgen]
extern {
    #[wasm_bindgen(js_namespace = console)]
    fn log(msg: &amp;str);
}

// A macro to provide `println!(..)`-style syntax for `console.log` logging.
macro_rules! log {
    ($($t:tt)*) =&gt; (log(&amp;format!($($t)*)))
}
#}</code></pre></pre>
<p>Then, we can start logging messages to the console by inserting calls to <code>log</code>
in Rust code. For example, to log each cell's state, live neighbors count, and
next state, we could modify our code like this:</p>
<pre><code class="language-diff">diff --git a/src/lib.rs b/src/lib.rs
index f757641..a30e107 100755
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -63,6 +63,11 @@ impl Universe {
                 let cell = self.cells[idx];
                 let live_neighbors = self.live_neighbor_count(row, col);

+                log!(
+                    &quot;cell[{}, {}] is initially {:?} and has {} live neighbors&quot;,
+                    row, col, cell, live_neighbors
+                );
+
                 let next_cell = match (cell, live_neighbors) {
                     // Rule 1: Any live cell with fewer than two live neighbours
                     // dies, as if caused by underpopulation.
@@ -80,6 +85,8 @@ impl Universe {
                     (otherwise, _) =&gt; otherwise,
                 };

+                log!(&quot;    it becomes {:?}&quot;, next_cell);
+
                 next[idx] = next_cell;
             }
         }
</code></pre>
<p>Alternatively, the <code>console.error</code> function has the same interface as
<code>console.log</code>, but developer tools tend to also capture and display a stack
trace alongside the logged message when <code>console.error</code> is used.</p>
<a class="header" href="#references" id="references"><h3>References</h3></a>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Console">The <code>console</code> object</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Tools/Web_Console">Firefox Developer Tools â€” Web Console</a></li>
<li><a href="https://docs.microsoft.com/en-us/microsoft-edge/devtools-guide/console">Microsoft Edge Developer Tools â€” Console</a></li>
<li><a href="https://developers.google.com/web/tools/chrome-devtools/console/get-started">Get Started with the Chrome DevTools Console</a></li>
</ul>
<a class="header" href="#logging-panics" id="logging-panics"><h2>Logging Panics</h2></a>
<p><a href="https://github.com/rustwasm/console_error_panic_hook">The <code>console_error_panic_hook</code> crate logs unexpected panics to the developer
console via <code>console.error</code>.</a> Rather than getting cryptic,
difficult-to-debug <code>RuntimeError: unreachable executed</code> error messages, this
gives you Rust's formatted panic message.</p>
<p>All you need to do is install the hook in an initialization function or common
code path:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate console_error_panic_hook;

// Expose an `init` function to be called by JS after instantiating the wasm
// module which installs the `console.error` panic hook.
#[wasm_bindgen]
pub fn init() {
    use std::panic;
    panic::set_hook(Box::new(console_error_panic_hook::hook));
}

// OR

// Ensure the the panic hook is set on some common code path. Under the hood,
// this makes sure that it is only installed once.
console_error_panic_hook::set_once();
#}</code></pre></pre>
<a class="header" href="#using-a-debugger" id="using-a-debugger"><h2>Using a Debugger</h2></a>
<p>Unfortunately, the debugging story for WebAssembly is still immature. On most
Unix systems, <a href="http://dwarfstd.org/">DWARF</a> is used to encode the information that a debugger
needs to provide source-level inspection of a running program. There is an
alternative format that encodes similar information on Windows. Currently, there
is no equivalent for WebAssembly. Therefore, debuggers currently provide limited
utility, and we end up stepping through raw WebAssembly instructions emitted by
the compiler, rather than the Rust source text we authored.</p>
<p>Nonetheless, debuggers are still useful for inspecting the JavaScript that
interacts with our WebAssembly. For example, we can use the debugger to pause on
each iteration of our <code>renderLoop</code> function. This provides us with a convenient
checkpoint for inspecting logged messages, and comparing the currently rendered
frame to the previous one.</p>
<p><a href="../images/game-of-life/debugging.png"><img src="../images/game-of-life/debugging.png" alt="Screenshot of debugging the Game of Life" /></a></p>
<a class="header" href="#references-1" id="references-1"><h3>References</h3></a>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Tools/Debugger">Firefox Developer Tools â€” Debugger</a></li>
<li><a href="https://docs.microsoft.com/en-us/microsoft-edge/devtools-guide/debugger">Microsoft Edge Developer Tools â€” Debugger</a></li>
<li><a href="https://developers.google.com/web/tools/chrome-devtools/javascript/">Get Started with Debugging JavaScript in Chrome DevTools</a></li>
</ul>
<a class="header" href="#avoid-the-need-to-debug-webassembly-in-the-first-place" id="avoid-the-need-to-debug-webassembly-in-the-first-place"><h2>Avoid the Need to Debug WebAssembly in the First Place</h2></a>
<p>While some bugs are specific to interfacing JavaScript and WebAssembly,
experience says that most are not. Try to reproduce bugs as normal Rust
<code>#[test]</code> functions, where you can leverage your OS's mature native tooling when
debugging. Use testing crates like <a href="https://crates.io/crates/quickcheck"><code>quickcheck</code></a> to exercise the
interface you expose to JavaScript. Ultimately, you will have an easier time
finding and fixing bugs if you can isolate them in a smaller test cases that
don't require interacting with JavaScript.</p>
<p>Note that in order to run the <code>#[test]</code>s without compiler and linker errors, you
will need to comment out the <code>#![wasm_bindgen]</code> annotations and <code>crate-type = &quot;cdylib&quot;</code> bits.</p>
<a class="header" href="#exercises" id="exercises"><h2>Exercises</h2></a>
<ul>
<li>
<p>Add logging to the <code>tick</code> function that records the row and column of each
cell that transitioned states from live to dead or vice versa.</p>
</li>
<li>
<p>Introduce a <code>panic!()</code> in the <code>Universe::new</code> method. Inspect the panic's
backtrace in your Web browser's JavaScript debugger. Disable debug symbols,
rebuild, and inspect the stack trace again. Not as useful, is it?</p>
</li>
<li>
<p>Checkout the <code>chapter-one-with-bug</code> branch. Rebuild and reload the Web
page. It should now be obvious that this branch's implementation contains a
bug, and every cell is apparently alive. This is a Real World(tm) bug that
your author made when initially creating the example code. Find the bug and
fix it. <em>Don't look at the commit history! That's cheating ;-)</em></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../game-of-life/implementing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../game-of-life/interactivity.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../game-of-life/implementing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../game-of-life/interactivity.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
